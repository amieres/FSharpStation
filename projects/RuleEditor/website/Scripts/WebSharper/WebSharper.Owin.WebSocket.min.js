(function(){"use strict";var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t;a=self;b=a.WebSharper=a.WebSharper||{};c=b.Owin=b.Owin||{};d=c.WebSocket=c.WebSocket||{};e=d.JsonEncoding=d.JsonEncoding||{};f=d.Async=d.Async||{};g=d.Endpoint=d.Endpoint||{};h=d.Client=d.Client||{};i=h.Message=h.Message||{};j=b&&b.Obj;k=h.WebSocketServer=h.WebSocketServer||{};l=h.WithEncoding=h.WithEncoding||{};m=a.IntelliFactory;n=m&&m.Runtime;o=b&&b.Control;p=o&&o.MailboxProcessor;q=b&&b.Concurrency;r=a.JSON;s=b&&b.Json;t=b&&b.Seq;e=d.JsonEncoding=n.Class({ClientProviderOrElse:function(u){return this.$==1?u:u;}},null,e);e.Readable=new e({$:1});e.Typed=new e({$:0});f.FoldAgent=function(u,v){return p.Start(function(w){function x(y){var z;z=null;return q.Delay(function(){return q.Bind(w.Receive(null),function(A){return q.Bind(v(y,A),function(B){return x(B);});});});}return x(u);},null);};g.CreateRemote=function(u,v){return g.New(u,"",v==null?e.Typed:v.$0);};g.New=function(u,v,w){return{URI:u,Route:v,JsonEncoding:w};};i.Close={$:3};i.Open={$:2};i.Error={$:1};k=h.WebSocketServer=n.Class({Post:function(u){this.conn.send(this.encode(u));},get_Connection:function(){return this.conn;}},j,k);k.New=n.Ctor(function(u,v){j.New.call(this);this.conn=u;this.encode=v;},k);l.Connect=function(u,v,w,x){return l.FromWebSocket(u,v,new a.WebSocket(w.URI),x,w.JsonEncoding);};l.ConnectStateful=function(u,v,w,x){return l.FromWebSocketStateful(u,v,new a.WebSocket(w.URI),x,w.JsonEncoding);};l.FromWebSocket=function(u,v,w,x,y){var z,A,B,C,D;z=h.getEncoding(u,v,y);A=z[1];B=h.cacheSocket(w,A);C=new k.New(w,z[0]);D=null;return q.Delay(function(){return q.Bind(x(C),function(E){function F(G,H){var I;I=B(E);w.onopen=function(){E(i.Open);return G(C);};w.onclose=function(){return E(i.Close);};w.onmessage=function(J){return E({$:0,$0:A(J)});};w.onerror=function(){E(i.Error);return H(new a.Error("Could not connect to the server."));};I?G(C):void 0;}return q.FromContinuations(function(G,H,I){return F.apply(null,[G,H,I]);});});});};l.FromWebSocketStateful=function(u,v,w,x,y){var z,A,B,C,D;z=h.getEncoding(u,v,y);A=z[1];B=h.cacheSocket(w,A);C=new k.New(w,z[0]);D=null;return q.Delay(function(){return q.Bind(x(C),function(E){var F,G;function H(I,J){var K;K=B(function(L){G.mailbox.AddLast(L);G.resume();});w.onopen=function(){G.mailbox.AddLast(i.Open);G.resume();return I(C);};w.onclose=function(){G.mailbox.AddLast(i.Close);return G.resume();};w.onmessage=function(L){G.mailbox.AddLast({$:0,$0:A(L)});return G.resume();};w.onerror=function(){G.mailbox.AddLast(i.Error);G.resume();return J(new a.Error("Could not connect to the server."));};K?I(C):void 0;}F=E[1];G=f.FoldAgent(E[0],function(I,J){return(F(I))(J);});return q.FromContinuations(function(I,J,K){return H.apply(null,[I,J,K]);});});});};h.getEncoding=function(u,v,w){var x,y;function z(A){return r.parse(A);}x=w.$==0?[function(A){return r.stringify(A);},function(A){return s.Activate(z(A));}]:[u,v];y=x[1];return[x[0],function(A){return y(A.data);}];};h.cacheSocket=function(u,v){var w,x;w=[];x=[false];u.onopen=function(){w.push(i.Open);x[0]=true;};u.onclose=function(){return w.push(i.Close);};u.onmessage=function(y){return w.push({$:0,$0:v(y)});};u.onerror=function(){return w.push(i.Error);};return function(y){t.iter(y,w);return x[0];};};}());
